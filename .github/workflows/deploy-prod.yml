# ==============================================================================
# MoneyMate - Manual Production Deployment
# Manual trigger with approval for production deployments
# ==============================================================================
name: Deploy Production (Manual)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Type 'deploy' to confirm production deployment"
        required: true
        type: string
      skip_backup:
        description: "Skip database backup before deploy"
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-prod
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository_owner }}/moneymate

jobs:
  # ----------------------------------------------------------------------------
  # Validate deployment request
  # ----------------------------------------------------------------------------
  validate:
    name: Validate Request
    runs-on: ubuntu-latest
    steps:
      - name: Check confirmation
        if: github.event.inputs.confirm != 'deploy'
        run: |
          echo "âŒ Deployment not confirmed. You must type 'deploy' to proceed."
          exit 1

      - name: Confirm deployment
        run: |
          echo "## ðŸš€ Production Deployment Confirmed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Skip backup:** ${{ github.event.inputs.skip_backup }}" >> $GITHUB_STEP_SUMMARY

  # ----------------------------------------------------------------------------
  # Build & push images
  # ----------------------------------------------------------------------------
  build:
    name: Build Images
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push server
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.server
          target: runtime
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/server:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/server:production
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push client
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.client
          target: runtime
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/client:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/client:production
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build & push OCR worker
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.ocr
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ocr-worker:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/ocr-worker:production
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ----------------------------------------------------------------------------
  # Deploy to production VM
  # ----------------------------------------------------------------------------
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    environment: production
    steps:
      - name: Backup database
        if: github.event.inputs.skip_backup != 'true'
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            echo "ðŸ“¦ Creating pre-deploy backup..."
            BACKUP_DIR="/opt/moneymate/backups"
            mkdir -p "$BACKUP_DIR"
            if docker ps --format '{{.Names}}' | grep -q moneymate-postgres; then
              docker exec moneymate-postgres pg_dump -U postgres moneymate | \
                gzip > "$BACKUP_DIR/pre-deploy-$(date +%Y%m%d-%H%M%S).sql.gz"
              echo "âœ… Backup created"
            else
              echo "âš ï¸ PostgreSQL not running, skipping backup"
            fi

      - name: Deploy to VM
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          command_timeout: 10m
          script_stop: true
          script: |
            set -euo pipefail
            APP_DIR="/opt/moneymate"
            COMPOSE_CMD="docker compose -f docker-compose.yml -f docker-compose.prod.yml"

            echo "ðŸš€ Production deployment starting..."
            echo "   Commit: ${{ github.sha }}"
            cd "$APP_DIR"

            # Save current commit for rollback
            PREV_COMMIT=$(git rev-parse HEAD)
            echo "$PREV_COMMIT" > /tmp/moneymate-prev-commit

            # Pull latest code
            git fetch origin main
            git reset --hard origin/main

            # Pull images
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            $COMPOSE_CMD pull 2>/dev/null || true
            $COMPOSE_CMD build

            # Run migrations
            $COMPOSE_CMD run --rm server npx prisma migrate deploy

            # Rolling restart
            $COMPOSE_CMD up -d --remove-orphans

            echo "â³ Waiting for services to stabilize..."
            sleep 20

            # Health check
            RETRIES=5
            for i in $(seq 1 $RETRIES); do
              if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "âœ… Health check passed (attempt $i)"
                break
              fi
              if [ "$i" -eq "$RETRIES" ]; then
                echo "âŒ Health check failed after $RETRIES attempts!"
                echo "ðŸ”„ Rolling back to $PREV_COMMIT..."
                git reset --hard "$PREV_COMMIT"
                $COMPOSE_CMD build
                $COMPOSE_CMD up -d
                echo "âš ï¸ Rolled back!"
                exit 1
              fi
              echo "  Attempt $i/$RETRIES failed, retrying in 5s..."
              sleep 5
            done

            echo ""
            echo "âœ… Production deployment complete!"
            $COMPOSE_CMD ps

  # ----------------------------------------------------------------------------
  # Smoke tests
  # ----------------------------------------------------------------------------
  smoke-test:
    name: Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Run smoke tests
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.GCP_VM_HOST }}
          username: ${{ secrets.GCP_VM_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            echo "ðŸ§ª Running smoke tests..."

            # Test API health endpoint
            echo -n "  Health endpoint: "
            if curl -sf http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "âœ… OK"
            else
              echo "âŒ FAIL"
              exit 1
            fi

            # Test client (frontend)
            echo -n "  Frontend:        "
            if curl -sf http://localhost:8080 > /dev/null 2>&1; then
              echo "âœ… OK"
            else
              echo "âŒ FAIL"
              exit 1
            fi

            # Test API login endpoint responds (400 expected without body)
            echo -n "  Auth endpoint:   "
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/auth/login)
            if [ "$STATUS" -lt "500" ]; then
              echo "âœ… OK (HTTP $STATUS)"
            else
              echo "âŒ FAIL (HTTP $STATUS)"
              exit 1
            fi

            # Check all containers running
            echo ""
            echo "ðŸ“Š Container status:"
            docker compose -f /opt/moneymate/docker-compose.yml \
              -f /opt/moneymate/docker-compose.prod.yml ps

            echo ""
            echo "âœ… All smoke tests passed!"

      - name: Summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
